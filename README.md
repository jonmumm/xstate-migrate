
# xstate-migrate

`xstate-migrate` is a migration library for persisted XState machines, designed to facilitate state machine migrations when updating your XState configurations. This library generates and applies migration patches to ensure seamless transitions between different versions of your state machines.

## Features

- Generate migration patches for XState machines
- Apply migration patches to persisted snapshots
- Handle nested and parallel state machines
- Support for adding and removing context properties

## Installation

You can install `xstate-migrate` using npm:

```bash
npm install xstate-migrate
```

## Usage

### Generating Migrations

Use the `generateMigrations` function to generate a set of migration patches between the current and a new version of an XState machine.

```typescript
import { createMachine, createActor } from 'xstate';
import { generateMigrations } from 'xstate-migrate';

// Define your initial state machine
const machineV1 = createMachine({
  id: 'nested',
  initial: 'parent',
  context: { data: '' },
  states: {
    parent: {
      initial: 'child1',
      states: {
        child1: { on: { NEXT: 'child2' } },
        child2: {},
      },
    },
  },
});

// Create an actor and get the initial snapshot
const actor = createActor(machineV1).start();
actor.send({ type: 'NEXT' });
const persistedSnapshot = actor.getSnapshot();

// Define your new state machine
const machineV2 = createMachine({
  id: 'nested',
  initial: 'parent',
  context: { data: '', newData: '' },
  states: {
    parent: {
      initial: 'child1',
      states: { child1: {}, child3: {} },
    },
  },
});

// Generate the migration patches
const migrations = generateMigrations(machineV2, persistedSnapshot);

console.log(migrations);
/*
[
  { op: 'replace', path: '/value/parent', value: 'child1' },
  { op: 'add', path: '/context/newData', value: '' }
]
*/
```

### Applying Migrations

Use the `applyMigrations` function to apply a set of migration patches to a persisted snapshot.

```typescript
import { applyMigrations } from 'xstate-migrate';

const persistedSnapshot = {
  context: { data: '' },
  value: { parent: 'child2' },
  status: 'active',
};

const migrations = [
  { op: 'replace', path: '/value/parent', value: 'child1' },
  { op: 'add', path: '/context/newData', value: '' },
];

const migratedSnapshot = applyMigrations(persistedSnapshot, migrations);

console.log(migratedSnapshot);
/*
{
  context: { data: '', newData: '' },
  value: { parent: 'child1' },
  status: 'active'
}
*/
```

## How Migrations Work

- Migrations are generated as a list of JSON Patch operations that describe the changes needed to update a persisted snapshot to match a new state machine configuration.
- The operations can include adding, removing, or replacing properties in the state machine's context or value.
- The `generateMigrations` function compares the initial snapshot of the new state machine with the persisted snapshot and creates the necessary operations.
- The `applyMigrations` function applies these operations to the persisted snapshot, updating it to reflect the new state machine configuration.

## API

### `generateMigrations(machine: AnyStateMachine, persistedSnapshot: any): Operation[]`

Generates a list of migration patches for updating a persisted snapshot to match the new state machine configuration.

- `machine`: The new version of the state machine.
- `persistedSnapshot`: The persisted snapshot of the previous state machine.

### `applyMigrations(persistedSnapshot: any, migrations: Operation[]): any`

Applies a list of migration patches to a persisted snapshot.

- `persistedSnapshot`: The persisted snapshot to be migrated.
- `migrations`: The list of migration patches to apply.

### Migration Format

The migrations generated by `xstate-migrate` follow the [JSON Patch](http://jsonpatch.com) standard (RFC 6902). JSON Patch is a format for describing changes to a JSON document. It is a JSON document itself that contains an array of operations. Each operation is an object with the following properties:

- `op`: The operation to perform. Can be one of `add`, `remove`, `replace`, `move`, `copy`, or `test`.
- `path`: A JSON Pointer that indicates the location in the target document where the operation is to be performed.
- `value`: The value to be used within the operations `add`, `replace`, and `test`.

Example migration:

```json
[
  { "op": "add", "path": "/context/newProp", "value": "default" }
]
```

## License

This project is licensed under the MIT License.
